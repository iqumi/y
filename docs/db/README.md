# Архитекутра

Для хранения данных используются cassandra и valkey

![model](https://github.com/iqumi/y/blob/main/docs/db/database-model.png)

Таблица `chats` хранит и приватные и групповые чаты. Поле `user_chat_id` в зависимости от типа чата хранит либо `chat_id` либо `user_id`. Для последующего их отображения необходимо получать так же имя собеседника/чата и его последнее сообщение. Так как это часто изменяющаяся информация эти два поля вынесены в кеш:

| chat:chat_id:message |
| -------------------- |
| message              |

| user:user_chat_id:name |
| ---------------------- |
| name                   |


## Аналитика

Вычисление размера разделов и занимаемого таблицами места на диске.

Размер раздела измеряется количеством ячеек (values). Рекомендуемый размер раздела не более 100 000 ячеек. Первичные ключи формируют разделы, разделы в свою очередь распределяются по нодам кластера.

Ниже описывается один из сценариев использования при котором, происходит обмен сообщениями между учениками и преподавателями образовательной организации, отправка работ, материалов, лабораторных и прочих файлов. Информация сохраняется в пределах 10 лет.

За 10 лет ожидается количество записей в:
- 42 000 пользователей
- 70 000 групповых чатов = 42 000 / 30 * 50
    - 30 пользователей в чате минимум
    - 50 чатов у одного пользователя
- 420 000 приватных чатов
    - 10 чатов у одного пользователя
- 742 000 000 сообщений
    - 10 000 сообщений в одной беседе
    - 100 сообщений в одном приватном чате
        - 202 сообщения в месяц

В итоге по таблицам имеем следующее количество ячеек в одном разделе и занимаемое место таблиц на диске с учетом требований:

| таблица     | Nv  | S of 1 partition | S of cluster |
| ----------- | --- | ---------------- | ------------ |
| tags        | 1   | 152 bytes        | 17.02 MB     |
| users       | 3   | 744 bytes        | 31.25 MB     |
| chats       | 60  | 2416 bytes       | 101.47 MB    |
| group_chats | 62  | 1694 bytes       | 118.58 MB    |
| messages    | 808 | 0.85 MB          | 20.82 TB     |

Следует так же учесть репликацию в будущем


##### Используемые величины в байтах

- 64 для group_chats.name
- 16 для group_chats.nickname
- 128 для group_chats.description
- 128 для tags.tag
- 128 для users.name
- 320 для users.email
- 256 для users.bio
- 4096 для messages.text
- 32 для messages.data


## Ссылки

- Cassandra: The Definitive Guide by Jeff Carpenter and Eben Hewitt
