# Архитекутра

Архитектурные решения и ход мыслей при проектировании схемы nosql базы данных для мессенджера:

![model](https://github.com/iqumi/y/blob/main/docs/db/database-model.png)

Таблица `chats` хранит и приватные и групповые чаты, ее поля:
- `user_id` поле для выборки чатов пользователя, в программе мы получаем его сразу после авторизации пользователя или когда клиент нам отдает его после установления соединения по WebSockets;
- `chat_id` должен быть как и у приватного чата так и у группового, так как если рассматривать чат как отношение двух пользователей, то чтобы получать все сообщения нужны будут два запроса на выборку;
- `name` имя беседы или второго пользователя для отображения. Если запрашивать имя у таблицы `users` каждый раз для каждого чата, соблюдая data consistency выйдет слишком много запросов к бд `O(1*n)`, где n количество чатов пользователя;
    - Если пользователь и меняет имя в таблице `users`, то следом мы меняем его и в `chats`. Для больших груп можно в in memory cache изменения заносить и от туда брать, а потом уже исправлять в базе, так нагрузка меньше на ноду;

Пример таблицы `chats`:

| user_id | chat_id | last_message | name     | type    |
| ------- | ------- | ------------ | -------- | ------- |
| 2       | 1       | Vova: hi     | Vova     | private |
| 1       | 1       | Vova: hi     | Seriy    | private |
| 1       | 2       | Max: help    | C++ Club | group   |


## Согласованность данных

Задача согласования данных лежит на программе, использующей бд. В отрыве от нее, вот те поля которые необходимо обновлять:

| если меняется         | надо изменить      |
| --------------------- | ------------------ |
| message.text          | chats.last_message |
| group_chat_users.name | chats.name         |
| users.name            | chats.name         |


## Аналитика

Вычисление размера разделов и занимаемого таблицами места на диске.

Размер раздела измеряется количеством ячеек (values). Рекомендуемый размер раздела не более 100 000 ячеек. Первичные ключи формируют разделы, разделы в свою очередь распределяются по нодам кластера.

Ниже описывается один из сценариев использования при котором, происходит обмен сообщениями между учениками и преподавателями образовательной организации, отправка работ, материалов, лабораторных и прочих файлов. Информация сохраняется в пределах 10 лет.

За 10 лет ожидается количество записей в:
- 42 000 пользователей
- 70 000 групповых чатов = 42 000 / 30 * 50
    - 30 пользователей в чате минимум 
    - 50 чатов у одного пользователя
- 420 000 приватных чатов
    - 10 чатов у одного пользователя
- 742 000 000 сообщений
    - 10 000 сообщений в одной беседе
    - 100 сообщений в одном приватном чате

В итоге по таблицам имеем следующее количество ячеек в одном разделе и занимаемое место таблиц на диске с учетом требований:

| таблица          | Nv     | S of 1 partition | S of cluster |
| ---------------- | ------ | ---------------- | ------------ |
| users            | 1      | 408 bytes        | 17.14 MB     | 
| users_by_name    | 1      | 152 bytes        | 6.38 MB      |
| chats_by_name    | 1      | 152 bytes        | 10.64 MB     |
| private_chats    | 1      | 56 bytes         | 23.56 MB     | 
| group_chat_users | 62     | 1694 bytes       | 118,58 MB    |
| messages         | 50 500 | 42.74 MB         | 3.14 TB      | 
| chats            | 160    | 5196 bytes       | 218.23 MB    |

Следует так же учесть репликацию в будущем.


#### Пример подсчета

Интересующимся, прошу проверять информацию самим. Для таблицы messages советую считать отдельно записи для приватных и бесед. Пример подсчета для таблицы chats: 

Nr = 60 чатов / 1 пользователя = 60 записей в разделе
Nv = 16+60*(5-2-0)+0 = 160 ячеек
S = 16+60*(32+32+1)+160*8 = 5196 bytes 
S of cluster = 5196 * 42 000

Подробнее см в книге. 


##### Используемые величины в байтах

- 64 для group_chat_users.name
- 16 для group_chat_users.nickname
- 128 для group_chat_users.description
- 32 для chats.name and chats.last_message
- 128 для username and chatname
- 128 для users.name
- 256 для users.bio
- 4096 для messages.text
- 32 для messages.data


## Размышления 

- При каждом новом сообщении в `messages` необходимо менять `chats.last_message`, та же история и с другими полями этой таблицы. Решением может являться in memory cache, тогда `chats.last_message` можно брать из кеша и менять его там же. Тогда таблица `chats` будет переноситься в кеш 100%

- Если это групповой чат с n пользователями то после изменения имени в таблице `chats.name` надо менять имя чата для n пользователей. То же самое с `last_message`. Хотя с кэшем наверное ок будет


## Ссылки

- Cassandra: The Definitive Guide by Jeff Carpenter and Eben Hewitt


